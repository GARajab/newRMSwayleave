
<div class="bg-white dark:bg-slate-800/50 shadow-lg rounded-xl ring-1 ring-slate-900/5">
    @if (isLoading()) {
        <div class="p-12 flex justify-center items-center">
            <app-spinner message="Loading users..."></app-spinner>
        </div>
    } @else if (error()) {
        <div class="p-8 text-center">
            <p class="text-red-500 dark:text-red-400 font-semibold">Error</p>
            <p class="text-slate-600 dark:text-slate-300 mt-2">{{ error() }}</p>
        </div>
    } @else {
        <div class="overflow-x-auto">
            <table class="min-w-full">
            <thead class="bg-slate-50 dark:bg-slate-700/50">
                <tr>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-gray-500 dark:text-gray-300 uppercase tracking-wider">User</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-gray-500 dark:text-gray-300 uppercase tracking-wider">Status</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-gray-500 dark:text-gray-300 uppercase tracking-wider">Role</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-gray-500 dark:text-gray-300 uppercase tracking-wider">Action</th>
                </tr>
            </thead>
            <tbody class="bg-white dark:bg-slate-800 divide-y divide-slate-200/75 dark:divide-slate-700/50">
                @for(user of users(); track user.id; let i = $index) {
                    @let status = getUserStatus(user);
                    @let role = getUserRole(user);
                    <tr class="animate-fade-in-up hover:bg-slate-50/50 dark:hover:bg-slate-900/20 transition-colors duration-150" [style.animation-delay]="i * 50 + 'ms'">
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            <p class="font-medium text-gray-900 dark:text-white">{{ user.email }}</p>
                            <p class="text-gray-500 dark:text-gray-400">Registered: {{ user.created_at | date:'shortDate' }}</p>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                             @if(status === 'active') {
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-500/10 dark:text-green-400">
                                    Active
                                </span>
                            } @else {
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800 dark:bg-yellow-500/10 dark:text-yellow-400">
                                    Pending
                                </span>
                            }
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                           @if (status === 'active') {
                                <select 
                                    [ngModel]="role" 
                                    (change)="onRoleChange(user, $event)"
                                    [disabled]="user.id === selfId || updatingStates()[user.id]"
                                    class="block w-full max-w-[150px] pl-3 pr-10 py-2 text-base border-gray-300 dark:border-gray-600 bg-white dark:bg-slate-700 dark:text-white focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm rounded-md transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                                    <option value="Unassigned">Unassigned</option>
                                    @for(r of assignableRoles; track r) {
                                        <option [value]="r">{{ r }}</option>
                                    }
                                </select>
                           } @else {
                               <span class="text-gray-400 dark:text-gray-500 italic">N/A</span>
                           }
                        </td>
                         <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            @if (status === 'active') {
                                <button 
                                    (click)="saveRoleChange(user)" 
                                    [disabled]="!isRoleChanged(user) || updatingStates()[user.id] || user.id === selfId"
                                    class="flex justify-center items-center w-20 px-3 py-1.5 bg-sky-500 text-white text-xs rounded-md shadow-sm hover:bg-sky-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500 disabled:bg-sky-300 dark:disabled:bg-slate-600 disabled:cursor-not-allowed transition-colors">
                                    @if (updatingStates()[user.id] && isRoleChanged(user)) {
                                        <app-spinner></app-spinner>
                                    } @else {
                                        <span>Save</span>
                                    }
                                </button>
                            } @else {
                                <button
                                    (click)="activateUser(user)"
                                    [disabled]="updatingStates()[user.id]"
                                    class="flex justify-center items-center w-24 px-3 py-1.5 bg-green-500 text-white text-xs rounded-md shadow-sm hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 disabled:bg-green-300 dark:disabled:bg-slate-600 disabled:cursor-not-allowed transition-colors">
                                     @if (updatingStates()[user.id]) {
                                        <app-spinner></app-spinner>
                                    } @else {
                                        <span>Activate</span>
                                    }
                                </button>
                            }
                        </td>
                    </tr>
                } @empty {
                    <tr>
                        <td colspan="4" class="px-6 py-12 text-center text-sm text-gray-500 dark:text-gray-400">
                            No users found.
                        </td>
                    </tr>
                }
            </tbody>
            </table>
        </div>
    }
</div>

@if (isConfirmAdminModalOpen() && userToMakeAdmin()) {
  <app-modal title="Confirm Admin Promotion" (close)="closeAdminConfirmModal()">
    <div class="text-center">
      <p class="text-lg text-gray-700 dark:text-gray-300 mb-6">
        Are you sure you want to grant
        <span class="font-bold">full administrator privileges</span> 
        to {{ userToMakeAdmin()!.email }}?
      </p>
      <div class="flex justify-center space-x-4">
        <button (click)="closeAdminConfirmModal()" class="px-6 py-2 border border-gray-300 dark:border-slate-600 rounded-md text-sm font-medium text-gray-700 dark:text-slate-300 hover:bg-gray-50 dark:hover:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500 transition-colors">
          Cancel
        </button>
        <button (click)="confirmAdminPromotion()" class="px-6 py-2 bg-red-600 text-white rounded-md shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-colors">
          Yes, grant admin
        </button>
      </div>
    </div>
  </app-modal>
}
