
<div class="bg-white dark:bg-slate-800/50 shadow-lg rounded-xl overflow-hidden ring-1 ring-slate-900/5">
  <div class="overflow-x-auto">
    <table class="min-w-full">
      <thead class="bg-slate-50 dark:bg-slate-700/50">
        <tr>
          <th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-gray-500 dark:text-gray-300 uppercase tracking-wider">Wayleave #</th>
          <th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-gray-500 dark:text-gray-300 uppercase tracking-wider">Status</th>
          <th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-gray-500 dark:text-gray-300 uppercase tracking-wider">Attachments</th>
          <th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-gray-500 dark:text-gray-300 uppercase tracking-wider">Last Update</th>
          <th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-gray-500 dark:text-gray-300 uppercase tracking-wider">Actions</th>
        </tr>
      </thead>
      <tbody class="bg-white dark:bg-slate-800 divide-y divide-slate-200/75 dark:divide-slate-700/50">
        @for (record of records(); track record.id; let i = $index) {
          @let lastHistory = record.history[record.history.length - 1];
          @let availableActions = getActionsForRecord(record.status, currentUser());
          @let styles = statusStyles()[record.status];
          <tr class="animate-fade-in-up hover:bg-slate-50/50 dark:hover:bg-slate-900/20 transition-colors duration-150" [style.animation-delay]="i * 50 + 'ms'">
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white">{{ record.wayleaveNumber }}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm">
              <div class="inline-flex items-center gap-2 px-2.5 py-1 rounded-full text-xs font-medium" [class]="styles.container">
                <div class="h-2 w-2 rounded-full" [class]="styles.dot"></div>
                <span>{{ record.status }}</span>
              </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
              <div class="flex flex-col gap-2">
                <div class="flex items-center justify-between gap-2">
                  <div class="flex items-center gap-2 overflow-hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-500 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd" />
                    </svg>
                    <div class="flex flex-col overflow-hidden">
                      <span class="truncate" [title]="record.attachment.name">{{ record.attachment.name }} ({{ formatFileSize(record.attachment.size) }})</span>
                      <span class="text-xs text-gray-400">Initial Document</span>
                    </div>
                  </div>
                  <button (click)="downloadFile(record.attachment.file)" [disabled]="!record.attachment.file" title="Download Initial Document" class="ml-2 p-1 text-slate-400 hover:text-cyan-600 dark:hover:text-cyan-300 disabled:text-slate-300 dark:disabled:text-slate-600 disabled:cursor-not-allowed flex-shrink-0 transition-transform hover:scale-110">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                  </button>
                </div>
                @if (record.approvedAttachment) {
                  <div class="flex items-center justify-between gap-2">
                    <div class="flex items-center gap-2 overflow-hidden">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-500 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                      </svg>
                      <div class="flex flex-col overflow-hidden">
                        <span class="truncate" [title]="record.approvedAttachment.name">{{ record.approvedAttachment.name }} ({{ formatFileSize(record.approvedAttachment.size) }})</span>
                        <span class="text-xs text-gray-400">Approved Document (TSS)</span>
                      </div>
                    </div>
                     <button (click)="downloadFile(record.approvedAttachment.file)" [disabled]="!record.approvedAttachment.file" title="Download Approved Document" class="ml-2 p-1 text-slate-400 hover:text-cyan-600 dark:hover:text-cyan-300 disabled:text-slate-300 dark:disabled:text-slate-600 disabled:cursor-not-allowed flex-shrink-0 transition-transform hover:scale-110">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                      </svg>
                    </button>
                  </div>
                }
              </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
              {{ lastHistory.timestamp | date:'short' }}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
              @if (availableActions.length > 0) {
                @for(action of availableActions; track action.label) {
                    <button (click)="openUpdateModal(record, action)" class="font-medium text-cyan-600 hover:text-cyan-500 dark:text-cyan-400 dark:hover:text-cyan-300 transition-all duration-150 hover:underline">
                      {{ action.label }}
                    </button>
                }
              } @else {
                <span class="text-gray-400 dark:text-gray-500 italic">No actions available</span>
              }
            </td>
          </tr>
        } @empty {
          <tr>
            <td colspan="5" class="px-6 py-12 text-center text-sm text-gray-500 dark:text-gray-400">
              No wayleave records found.
            </td>
          </tr>
        }
      </tbody>
    </table>
  </div>
</div>

@if (isUpdateModalOpen() && recordToUpdate() && actionToPerform()) {
  <app-modal [title]="'Update Wayleave Status'" (close)="closeUpdateModal()">
    <app-update-status-form 
      [record]="recordToUpdate()!"
      [action]="actionToPerform()!"
      [isLoading]="isUpdatingStatus()"
      (updateConfirmed)="handleStatusUpdate($event)"
      (updateCancelled)="closeUpdateModal()">
    </app-update-status-form>
  </app-modal>
}
